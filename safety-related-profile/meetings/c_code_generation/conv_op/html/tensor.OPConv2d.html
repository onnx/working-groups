<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<link rel="stylesheet" type="text/css" href="style.css">
<link rel="stylesheet" type="text/css" href="icofont.min.css">
<title>Module tensor.OPConv2d</title>
</head>
<body>
<header><a href="index.html">index</a> — <code>library <a href="tensor.index.html">tensor</a></code> — <code>module OPConv2d</code></header>
<pre class="src">
<span class="keyword">module</span> <span class="scope">OPConv2d</span><a href="tensor.proof.html#OPConv2d" title="Partial proof (22/24 goals)" class="icon warning icofont-error"></a>
  <span class="keyword">use</span> <a title="tensor.Tensor" href="tensor.Tensor.html">Tensor</a>
  <span class="keyword">use</span> <a title="tensor.Range" href="tensor.Range.html">Range</a>
  <span class="keyword">use</span> int.<a title="int.Int" href="https://www.why3.org/stdlib/int.html#Int_">Int</a>
  <span class="keyword">use</span> real.<a title="real.Real" href="https://www.why3.org/stdlib/real.html#Real_">Real</a>
  <span class="keyword">use</span> std.<a title="std.List" href="std.List.html">List</a>
  <span class="keyword">use</span> std.<a title="std.Int" href="std.Int.html">Int</a>
  <span class="keyword">use</span> std.<a title="std.Cint" href="std.Cint.html">Cint</a>
  <span class="keyword">use</span> list.<a title="list.List" href="https://www.why3.org/stdlib/list.html#List_">List</a>
  <span class="keyword">use</span> list.<a title="list.Length" href="https://www.why3.org/stdlib/list.html#Length_">Length</a>
  <span class="keyword">use</span> list.<a title="list.Nth" href="https://www.why3.org/stdlib/list.html#Nth_">Nth</a>
  <span class="keyword">use</span> std.<a title="std.Cfloat" href="std.Cfloat.html">Cfloat</a>
  <span class="keyword">use</span> ref.<a title="ref.Ref" href="https://www.why3.org/stdlib/ref.html#Ref_">Ref</a>



<span class="comment">(* ===== SECTION 1: Helper function for padding (Zero-Padding) ===== *)</span>
</pre>
<div class="doc">
<p>A helper function to access the padded input tensor value.</p>
</div>
<pre class="src">
<span class="comment">(* Goal: Retrieves a value from the input tensor X, accounting for zero-padding.
 * If the effective coordinates (x_h, x_w), after removing padding, fall outside the original tensor bounds, it returns 0.0.
 * Inputs:
 * x: data real - The input tensor data function.
 * x_dims: list int - The dimensions of the input tensor X [N, C, H, W].
 * pad_top, pad_left: int - The padding applied to the top/left of the height/width dimensions.
 * n, c: int - Batch and input channel indices.
 * x_h, x_w: int - The coordinates in the conceptually padded input space (derived from output position, stride, and dilation).
 * Outputs: real - The value from the input tensor, or 0.0 if padded. *)</span>
  <span class="keyword">let</span> <span class="keyword">ghost</span> <span class="keyword">function</span> <a id="padded_value">padded_value</a><a href="tensor.proof.html#OPConv2d.padded_value" title="Valid (one goal)" class="icon valid icofont-check"></a> (x : <a title="tensor.Tensor.data" href="tensor.Tensor.html#data">data</a> real) (x_dims : <a title="list.List.list" href="https://www.why3.org/stdlib/list.html#list_8">list</a> int)
    (pad_top pad_left : int) (n c x_h x_w : int) : real =
     <span class="keyword">requires</span> { <a title="list.Length.length" href="https://www.why3.org/stdlib/list.html#length_24">length</a> x_dims = 4 }
    <span class="keyword">let</span> padded_h = x_h <a title="int.Int.(-)" href="https://www.why3.org/stdlib/int.html#infix%20-_23">-</a> pad_top <span class="keyword">in</span> <span class="comment">(* Convert padded index to original index *)</span>
    <span class="keyword">let</span> padded_w = x_w <a title="int.Int.(-)" href="https://www.why3.org/stdlib/int.html#infix%20-_23">-</a> pad_left <span class="keyword">in</span> <span class="comment">(* Convert padded index to original index *)</span>
    <span class="keyword">let</span> padded_ks = <a title="list.List.Cons" href="https://www.why3.org/stdlib/list.html#Cons_8">Cons</a> n (<a title="list.List.Cons" href="https://www.why3.org/stdlib/list.html#Cons_8">Cons</a> c (<a title="list.List.Cons" href="https://www.why3.org/stdlib/list.html#Cons_8">Cons</a> padded_h (<a title="list.List.Cons" href="https://www.why3.org/stdlib/list.html#Cons_8">Cons</a> padded_w <a title="list.List.Nil" href="https://www.why3.org/stdlib/list.html#Nil_8">Nil</a>))) <span class="keyword">in</span>
    <span class="keyword">if</span> <a title="tensor.Range.valid" href="tensor.Range.html#valid">valid</a> padded_ks x_dims <span class="keyword">then</span>
      x padded_ks <span class="comment">(* Return value if coordinates are within bounds *)</span>
    <span class="keyword">else</span>
      0.0 <span class="comment">(* Return 0.0 if coordinates are out of bounds *)</span>

<span class="comment">(* --- *)</span>

<span class="comment">(* ===== SECTION 2: Data-level Convolution (Weighted Sum) ===== *)</span>
</pre>
<div class="doc">
<p>The main 2D convolution data operation.</p>
</div>
<pre class="src">
<span class="comment">(* Goal: Defines the function that computes the value of a single output pixel Y[n, m, y_h, y_w].
 * This is achieved by iterating over all input channels (c), kernel height (i), and kernel width (j), performing the dot product, and adding the bias.
 * Inputs: Tensors (data functions) X, W, B, their dimensions, and all convolution attributes.
 * Outputs: data real - The data function for the output tensor Y. *)</span>
  <span class="keyword">let</span> <span class="keyword">ghost</span> <span class="keyword">function</span> <a id="dconv2d">dconv2d</a><a href="tensor.proof.html#OPConv2d.dconv2d" title="Valid (one goal)" class="icon valid icofont-check"></a> (x : <a title="tensor.Tensor.data" href="tensor.Tensor.html#data">data</a> real) (x_dims : <a title="list.List.list" href="https://www.why3.org/stdlib/list.html#list_8">list</a> int)
    (w : <a title="tensor.Tensor.data" href="tensor.Tensor.html#data">data</a> real) (w_dims : <a title="list.List.list" href="https://www.why3.org/stdlib/list.html#list_8">list</a> int) (b : <a title="tensor.Tensor.data" href="tensor.Tensor.html#data">data</a> real) (b_dims : <a title="list.List.list" href="https://www.why3.org/stdlib/list.html#list_8">list</a> int)
    (pad_top pad_bottom pad_left pad_right : int) (dil_h dil_w : int)
    (str_h str_w : int) : <a title="tensor.Tensor.data" href="tensor.Tensor.html#data">data</a> real
    <span class="keyword">requires</span> { <a title="list.Length.length" href="https://www.why3.org/stdlib/list.html#length_24">length</a> x_dims = 4 }  <span class="comment">(* X shape: [N, C, H, W] *)</span>
    <span class="keyword">requires</span> { <a title="list.Length.length" href="https://www.why3.org/stdlib/list.html#length_24">length</a> w_dims = 4 }  <span class="comment">(* W shape: [M, C, kH, kW] where M=C_out *)</span>
    <span class="keyword">requires</span> { <a title="list.Length.length" href="https://www.why3.org/stdlib/list.html#length_24">length</a> b_dims = 1 }  <span class="comment">(* [M, C, kH, kW] *)</span>
    <span class="keyword">requires</span> { <a title="std.Int.get_dim" href="std.Int.html#get_dim">get_dim</a> x_dims 1 = <a title="std.Int.get_dim" href="std.Int.html#get_dim">get_dim</a> w_dims 1 }  <span class="comment">(* C_in = C_kernel *)</span>
    <span class="keyword">requires</span> { <a title="std.Int.get_dim" href="std.Int.html#get_dim">get_dim</a> w_dims 0 = <a title="std.Int.get_dim" href="std.Int.html#get_dim">get_dim</a> b_dims 0 }  <span class="comment">(* M = M_bias (Output Channels must match Bias size) *)</span>
    <span class="keyword">requires</span> { str_h <a title="int.Int.(>)" href="https://www.why3.org/stdlib/int.html#infix%20%3E_24">&gt;</a> 0 /\ str_w <a title="int.Int.(>)" href="https://www.why3.org/stdlib/int.html#infix%20%3E_24">&gt;</a> 0 }
    <span class="keyword">requires</span> { dil_h <a title="int.Int.(>)" href="https://www.why3.org/stdlib/int.html#infix%20%3E_24">&gt;</a> 0 /\ dil_w <a title="int.Int.(>)" href="https://www.why3.org/stdlib/int.html#infix%20%3E_24">&gt;</a> 0 }
    = <span class="keyword">fun</span> yks -&gt;  <span class="comment">(* Input &#39;yks&#39; is the output coordinate list: [n, m, y_h, y_w] *)</span>
        <span class="keyword">if</span> <a title="list.Length.length" href="https://www.why3.org/stdlib/list.html#length_24">length</a> yks <a title="int.Int.(=)" href="https://www.why3.org/stdlib/int.html#infix%20=_16">&lt;&gt;</a> 4 <span class="keyword">then</span> 0.0 <span class="keyword">else</span>
        <span class="keyword">let</span> <a title="list.List.Cons" href="https://www.why3.org/stdlib/list.html#Cons_8">Cons</a> n (<a title="list.List.Cons" href="https://www.why3.org/stdlib/list.html#Cons_8">Cons</a> m (<a title="list.List.Cons" href="https://www.why3.org/stdlib/list.html#Cons_8">Cons</a> y_h (<a title="list.List.Cons" href="https://www.why3.org/stdlib/list.html#Cons_8">Cons</a> y_w <a title="list.List.Nil" href="https://www.why3.org/stdlib/list.html#Nil_8">Nil</a>))) = yks <span class="keyword">in</span> <span class="comment">(* Destructure output coordinates *)</span>
        <span class="keyword">let</span> c_in = <a title="std.Int.get_dim" href="std.Int.html#get_dim">get_dim</a> w_dims 1 <span class="keyword">in</span> <span class="comment">(* Number of input channels *)</span>
        <span class="keyword">let</span> kh = <a title="std.Int.get_dim" href="std.Int.html#get_dim">get_dim</a> w_dims 2 <span class="keyword">in</span> <span class="comment">(* Kernel height *)</span>
        <span class="keyword">let</span> kw = <a title="std.Int.get_dim" href="std.Int.html#get_dim">get_dim</a> w_dims 3 <span class="keyword">in</span> <span class="comment">(* Kernel width *)</span>

        <span class="keyword">let</span> sum_value = ref 0.0 <span class="keyword">in</span> <span class="comment">(* Accumulator for the convolution sum *)</span>
        <span class="keyword">for</span> c = 0 <span class="keyword">to</span> c_in <a title="int.Int.(-)" href="https://www.why3.org/stdlib/int.html#infix%20-_23">-</a> 1 <span class="keyword">do</span> <span class="comment">(* Loop over input channels *)</span>
          <span class="keyword">invariant</span> { <span class="keyword">true</span> }
          <span class="keyword">for</span> i = 0 <span class="keyword">to</span> kh <a title="int.Int.(-)" href="https://www.why3.org/stdlib/int.html#infix%20-_23">-</a> 1 <span class="keyword">do</span> <span class="comment">(* Loop over kernel height (i) *)</span>
            <span class="keyword">invariant</span> { <span class="keyword">true</span> }
            <span class="keyword">for</span> j = 0 <span class="keyword">to</span> kw <a title="int.Int.(-)" href="https://www.why3.org/stdlib/int.html#infix%20-_23">-</a> 1 <span class="keyword">do</span> <span class="comment">(* Loop over kernel width (j) *)</span>
              <span class="keyword">invariant</span> { <span class="keyword">true</span> }
              <span class="comment">(* Calculate corresponding H/W coordinate in the padded input X *)</span>
              <span class="keyword">let</span> x_h = y_h <a title="int.Int.(*)" href="https://www.why3.org/stdlib/int.html#infix%20*_20">*</a> str_h <a title="int.Int.(+)" href="https://www.why3.org/stdlib/int.html#infix%20+_19">+</a> i <a title="int.Int.(*)" href="https://www.why3.org/stdlib/int.html#infix%20*_20">*</a> dil_h <span class="keyword">in</span>
              <span class="keyword">let</span> x_w = y_w <a title="int.Int.(*)" href="https://www.why3.org/stdlib/int.html#infix%20*_20">*</a> str_w <a title="int.Int.(+)" href="https://www.why3.org/stdlib/int.html#infix%20+_19">+</a> j <a title="int.Int.(*)" href="https://www.why3.org/stdlib/int.html#infix%20*_20">*</a> dil_w <span class="keyword">in</span>
              <span class="keyword">let</span> x_val = <a title="tensor.OPConv2d.padded_value" href="#padded_value">padded_value</a> x x_dims pad_top pad_left n c x_h x_w <span class="keyword">in</span> <span class="comment">(* Get padded input value *)</span>
              <span class="keyword">let</span> w_coords = <a title="list.List.Cons" href="https://www.why3.org/stdlib/list.html#Cons_8">Cons</a> m (<a title="list.List.Cons" href="https://www.why3.org/stdlib/list.html#Cons_8">Cons</a> c (<a title="list.List.Cons" href="https://www.why3.org/stdlib/list.html#Cons_8">Cons</a> i (<a title="list.List.Cons" href="https://www.why3.org/stdlib/list.html#Cons_8">Cons</a> j <a title="list.List.Nil" href="https://www.why3.org/stdlib/list.html#Nil_8">Nil</a>))) <span class="keyword">in</span>
              <span class="keyword">let</span> w_val = w w_coords <span class="keyword">in</span> <span class="comment">(* Get kernel weight value *)</span>
              sum_value <a title="ref.Ref.(:=)" href="https://www.why3.org/stdlib/ref.html#infix%20:=_20">:=</a> <a title="ref.Ref.(!)" href="https://www.why3.org/stdlib/ref.html#prefix%20!_18">!</a>sum_value <a title="int.Int.(+)" href="https://www.why3.org/stdlib/int.html#infix%20+_19">+</a> (x_val <a title="int.Int.(*)" href="https://www.why3.org/stdlib/int.html#infix%20*_20">*</a> w_val) <span class="comment">(* Accumulate the product *)</span>
            <span class="keyword">done</span>
          <span class="keyword">done</span>
        <span class="keyword">done</span>;
        <span class="keyword">let</span> bias_coords = <a title="list.List.Cons" href="https://www.why3.org/stdlib/list.html#Cons_8">Cons</a> m <a title="list.List.Nil" href="https://www.why3.org/stdlib/list.html#Nil_8">Nil</a> <span class="keyword">in</span>
        <span class="keyword">let</span> bias_val = b bias_coords <span class="keyword">in</span> <span class="comment">(* Get the bias value for output channel m *)</span>
        <a title="ref.Ref.(!)" href="https://www.why3.org/stdlib/ref.html#prefix%20!_18">!</a>sum_value <a title="int.Int.(+)" href="https://www.why3.org/stdlib/int.html#infix%20+_19">+</a> bias_val <span class="comment">(* Final output value = Weighted Sum + Bias *)</span>

<span class="comment">(* --- *)</span>

<span class="comment">(* ===== SECTION 3: Tensor-level Convolution Operator and Shape Calculation ===== *)</span>
</pre>
<div class="doc">
<p>The tensor&ndash;level 2D convolution operator.</p>
</div>
<pre class="src">
<span class="comment">(* Goal: Constructs the final output tensor Y, calculating its dimensions and assigning the dconv2d data function.
 * Inputs: The three tensors X, W, B, and all convolution attributes.
 * Outputs: tensor real - The resulting output tensor Y [N_out, C_out, H_out, W_out]. *)</span>
  <span class="keyword">let</span> <span class="keyword">ghost</span> <span class="keyword">function</span> <a id="opconv2d">opconv2d</a><a href="tensor.proof.html#OPConv2d.opconv2d" title="Partial proof (20/22 goals)" class="icon warning icofont-error"></a> (x w b : <a title="tensor.Tensor.tensor" href="tensor.Tensor.html#tensor">tensor</a> real)
    (pad_top pad_bottom pad_left pad_right : int) (dil_h dil_w : int)
    (str_h str_w : int) : <a title="tensor.Tensor.tensor" href="tensor.Tensor.html#tensor">tensor</a> real
    <span class="keyword">requires</span> { <a title="list.Length.length" href="https://www.why3.org/stdlib/list.html#length_24">length</a> x.<a title="tensor.Tensor.dims" href="tensor.Tensor.html#dims">dims</a> = 4 }  <span class="comment">(* [N, C, H, W] *)</span>
    <span class="keyword">requires</span> { <a title="list.Length.length" href="https://www.why3.org/stdlib/list.html#length_24">length</a> w.<a title="tensor.Tensor.dims" href="tensor.Tensor.html#dims">dims</a> = 4 }  <span class="comment">(* [M, C, kH, kW] *)</span>
    <span class="keyword">requires</span> { <a title="list.Length.length" href="https://www.why3.org/stdlib/list.html#length_24">length</a> b.<a title="tensor.Tensor.dims" href="tensor.Tensor.html#dims">dims</a> = 1 }  <span class="comment">(* [M] *)</span>
    <span class="keyword">requires</span> { <a title="std.Int.get_dim" href="std.Int.html#get_dim">get_dim</a> x.<a title="tensor.Tensor.dims" href="tensor.Tensor.html#dims">dims</a> 1 = <a title="std.Int.get_dim" href="std.Int.html#get_dim">get_dim</a> w.<a title="tensor.Tensor.dims" href="tensor.Tensor.html#dims">dims</a> 1 }  <span class="comment">(* C_in = C_kernel *)</span>
    <span class="keyword">requires</span> { <a title="std.Int.get_dim" href="std.Int.html#get_dim">get_dim</a> w.<a title="tensor.Tensor.dims" href="tensor.Tensor.html#dims">dims</a> 0 = <a title="std.Int.get_dim" href="std.Int.html#get_dim">get_dim</a> b.<a title="tensor.Tensor.dims" href="tensor.Tensor.html#dims">dims</a> 0 }  <span class="comment">(* M = M_bias *)</span>
    <span class="keyword">requires</span> { str_h <a title="int.Int.(>)" href="https://www.why3.org/stdlib/int.html#infix%20%3E_24">&gt;</a> 0 /\ str_w <a title="int.Int.(>)" href="https://www.why3.org/stdlib/int.html#infix%20%3E_24">&gt;</a> 0 }
    <span class="keyword">requires</span> { dil_h <a title="int.Int.(>)" href="https://www.why3.org/stdlib/int.html#infix%20%3E_24">&gt;</a> 0 /\ dil_w <a title="int.Int.(>)" href="https://www.why3.org/stdlib/int.html#infix%20%3E_24">&gt;</a> 0 }
    <span class="keyword">requires</span> { pad_top <a title="int.Int.(>=)" href="https://www.why3.org/stdlib/int.html#infix%20%3E=_26">&gt;=</a> 0 /\ pad_bottom <a title="int.Int.(>=)" href="https://www.why3.org/stdlib/int.html#infix%20%3E=_26">&gt;=</a> 0 /\ pad_left <a title="int.Int.(>=)" href="https://www.why3.org/stdlib/int.html#infix%20%3E=_26">&gt;=</a> 0 /\ pad_right <a title="int.Int.(>=)" href="https://www.why3.org/stdlib/int.html#infix%20%3E=_26">&gt;=</a> 0 }
    <span class="keyword">ensures</span> { <a title="list.Length.length" href="https://www.why3.org/stdlib/list.html#length_24">length</a> result.<a title="tensor.Tensor.dims" href="tensor.Tensor.html#dims">dims</a> = 4 }
    <span class="keyword">ensures</span> { <a title="std.Int.get_dim" href="std.Int.html#get_dim">get_dim</a> result.<a title="tensor.Tensor.dims" href="tensor.Tensor.html#dims">dims</a> 0 = <a title="std.Int.get_dim" href="std.Int.html#get_dim">get_dim</a> x.<a title="tensor.Tensor.dims" href="tensor.Tensor.html#dims">dims</a> 0 }  <span class="comment">(* N_out = N_in *)</span>
    <span class="keyword">ensures</span> { <a title="std.Int.get_dim" href="std.Int.html#get_dim">get_dim</a> result.<a title="tensor.Tensor.dims" href="tensor.Tensor.html#dims">dims</a> 1 = <a title="std.Int.get_dim" href="std.Int.html#get_dim">get_dim</a> w.<a title="tensor.Tensor.dims" href="tensor.Tensor.html#dims">dims</a> 0 }  <span class="comment">(* C_out = M *)</span>
    <span class="comment">(* Main ensures clause: the output data must be exactly the function dconv2d *)</span>
    <span class="keyword">ensures</span> {result.<a title="tensor.Tensor.data" href="tensor.Tensor.html#data">data</a> = <a title="tensor.OPConv2d.dconv2d" href="#dconv2d">dconv2d</a> x.<a title="tensor.Tensor.data" href="tensor.Tensor.html#data">data</a> x.<a title="tensor.Tensor.dims" href="tensor.Tensor.html#dims">dims</a> w.<a title="tensor.Tensor.data" href="tensor.Tensor.html#data">data</a> w.<a title="tensor.Tensor.dims" href="tensor.Tensor.html#dims">dims</a> b.<a title="tensor.Tensor.data" href="tensor.Tensor.html#data">data</a> b.<a title="tensor.Tensor.dims" href="tensor.Tensor.html#dims">dims</a> 
                     pad_top pad_bottom pad_left pad_right dil_h dil_w str_h str_w} 
    <span class="section level1"><span class="comment">{</span><span class="attribute section-toggle">proof</span><span class="comment section-text active">…</span><span class="comment">}</span><span class="section-text">
    = <span class="keyword">let</span> n = <a title="std.Int.get_dim" href="std.Int.html#get_dim">get_dim</a> x.<a title="tensor.Tensor.dims" href="tensor.Tensor.html#dims">dims</a> 0 <span class="keyword">in</span>
      <span class="keyword">let</span> c_in = <a title="std.Int.get_dim" href="std.Int.html#get_dim">get_dim</a> x.<a title="tensor.Tensor.dims" href="tensor.Tensor.html#dims">dims</a> 1 <span class="keyword">in</span>
      <span class="keyword">let</span> h_in = <a title="std.Int.get_dim" href="std.Int.html#get_dim">get_dim</a> x.<a title="tensor.Tensor.dims" href="tensor.Tensor.html#dims">dims</a> 2 <span class="keyword">in</span>
      <span class="keyword">let</span> w_in = <a title="std.Int.get_dim" href="std.Int.html#get_dim">get_dim</a> x.<a title="tensor.Tensor.dims" href="tensor.Tensor.html#dims">dims</a> 3 <span class="keyword">in</span>
      <span class="keyword">let</span> m_out = <a title="std.Int.get_dim" href="std.Int.html#get_dim">get_dim</a> w.<a title="tensor.Tensor.dims" href="tensor.Tensor.html#dims">dims</a> 0 <span class="keyword">in</span>
      <span class="keyword">let</span> kh = <a title="std.Int.get_dim" href="std.Int.html#get_dim">get_dim</a> w.<a title="tensor.Tensor.dims" href="tensor.Tensor.html#dims">dims</a> 2 <span class="keyword">in</span>
      <span class="keyword">let</span> kw = <a title="std.Int.get_dim" href="std.Int.html#get_dim">get_dim</a> w.<a title="tensor.Tensor.dims" href="tensor.Tensor.html#dims">dims</a> 3 <span class="keyword">in</span>

      <span class="comment">(* Calculate Effective Kernel Size (with dilation) *)</span>
      <span class="keyword">let</span> effective_kh = (kh <a title="int.Int.(-)" href="https://www.why3.org/stdlib/int.html#infix%20-_23">-</a> 1) <a title="int.Int.(*)" href="https://www.why3.org/stdlib/int.html#infix%20*_20">*</a> dil_h <a title="int.Int.(+)" href="https://www.why3.org/stdlib/int.html#infix%20+_19">+</a> 1 <span class="keyword">in</span>
      <span class="keyword">let</span> effective_kw = (kw <a title="int.Int.(-)" href="https://www.why3.org/stdlib/int.html#infix%20-_23">-</a> 1) <a title="int.Int.(*)" href="https://www.why3.org/stdlib/int.html#infix%20*_20">*</a> dil_w <a title="int.Int.(+)" href="https://www.why3.org/stdlib/int.html#infix%20+_19">+</a> 1 <span class="keyword">in</span>
      <span class="comment">(* Calculate Output Height (H_out) using the convolution formula:
       * H_out = floor((H_in + P_top + P_bottom - effective_kH) / S_h) + 1 *)</span>
      <span class="keyword">let</span> out_h = (h_in <a title="int.Int.(+)" href="https://www.why3.org/stdlib/int.html#infix%20+_19">+</a> pad_top <a title="int.Int.(+)" href="https://www.why3.org/stdlib/int.html#infix%20+_19">+</a> pad_bottom <a title="int.Int.(-)" href="https://www.why3.org/stdlib/int.html#infix%20-_23">-</a> effective_kh) <a title="std.Cint.(./)" href="std.Cint.html#infix%20.%2F">./</a> (str_h <a title="int.Int.(+)" href="https://www.why3.org/stdlib/int.html#infix%20+_19">+</a> 1) <span class="keyword">in</span>
      <span class="comment">(* Calculate Output Width (W_out) *)</span>
      <span class="keyword">let</span> out_w = (w_in <a title="int.Int.(+)" href="https://www.why3.org/stdlib/int.html#infix%20+_19">+</a> pad_left <a title="int.Int.(+)" href="https://www.why3.org/stdlib/int.html#infix%20+_19">+</a> pad_right <a title="int.Int.(-)" href="https://www.why3.org/stdlib/int.html#infix%20-_23">-</a> effective_kw) <a title="std.Cint.(./)" href="std.Cint.html#infix%20.%2F">./</a> (str_w <a title="int.Int.(+)" href="https://www.why3.org/stdlib/int.html#infix%20+_19">+</a> 1) <span class="keyword">in</span>
      <span class="keyword">let</span> output_dims = <a title="list.List.Cons" href="https://www.why3.org/stdlib/list.html#Cons_8">Cons</a> n (<a title="list.List.Cons" href="https://www.why3.org/stdlib/list.html#Cons_8">Cons</a> m_out (<a title="list.List.Cons" href="https://www.why3.org/stdlib/list.html#Cons_8">Cons</a> out_h (<a title="list.List.Cons" href="https://www.why3.org/stdlib/list.html#Cons_8">Cons</a> out_w <a title="list.List.Nil" href="https://www.why3.org/stdlib/list.html#Nil_8">Nil</a>))) <span class="keyword">in</span>
      <span class="comment">(* Return the final output tensor record *)</span>
      { <a title="tensor.Tensor.dims" href="tensor.Tensor.html#dims">dims</a> = output_dims ;
      <a title="tensor.Tensor.data" href="tensor.Tensor.html#data">data</a> = <a title="tensor.OPConv2d.dconv2d" href="#dconv2d">dconv2d</a> x.<a title="tensor.Tensor.data" href="tensor.Tensor.html#data">data</a> x.<a title="tensor.Tensor.dims" href="tensor.Tensor.html#dims">dims</a> w.<a title="tensor.Tensor.data" href="tensor.Tensor.html#data">data</a> w.<a title="tensor.Tensor.dims" href="tensor.Tensor.html#dims">dims</a> b.<a title="tensor.Tensor.data" href="tensor.Tensor.html#data">data</a> b.<a title="tensor.Tensor.dims" href="tensor.Tensor.html#dims">dims</a> 
                     pad_top pad_bottom pad_left pad_right dil_h dil_w str_h str_w ;

        <a title="tensor.Tensor.background" href="tensor.Tensor.html#background">background</a> = 0.0 }

<span class="keyword">end</span>
</pre>
<script type="text/javascript" src="script.js"></script>
</body>
</html>

<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<link rel="stylesheet" type="text/css" href="style.css">
<link rel="stylesheet" type="text/css" href="icofont.min.css">
<title>Module libtensor.CTensor</title>
</head>
<body>
<header><a href="index.html">index</a> — <code>library <a href="libtensor.index.html">libtensor</a></code> — <code>module CTensor</code></header>
<pre class="src">
<span class="keyword">module</span> <span class="scope">CTensor</span><a href="libtensor.proof.html#CTensor" title="Partial proof (227/273 goals)" class="icon warning icofont-error"></a>
  <span class="keyword">use</span> int.<a title="int.Int" href="https://www.why3.org/stdlib/int.html#Int_">Int</a>
  <span class="keyword">use</span> std.<a title="std.List" href="std.List.html">List</a>
  <span class="keyword">use</span> std.<a title="std.Clib" href="std.Clib.html">Clib</a>
  <span class="keyword">use</span> std.<a title="std.Cfloat" href="std.Cfloat.html">Cfloat</a>
  <span class="keyword">use</span> mach.int.<a title="mach.int.Int32" href="https://www.why3.org/stdlib/mach.int.html#Int32_">Int32</a>
  <span class="keyword">use</span> tensor.<a title="tensor.Range" href="tensor.Range.html">Range</a>
  <span class="keyword">use</span> tensor.<a title="tensor.Tensor" href="tensor.Tensor.html">Tensor</a>
  <span class="keyword">use</span> tensor.<a title="tensor.OPWhere" href="tensor.OPWhere.html">OPWhere</a>
  <span class="keyword">use</span> layout.<a title="layout.CFlat" href="layout.CFlat.html">CFlat</a>
  <span class="keyword">use</span> libvector.<a title="libvector.CIndex" href="libvector.CIndex.html">CIndex</a>
  <span class="keyword">use</span> ref.<a title="ref.Ref" href="https://www.why3.org/stdlib/ref.html#Ref_">Ref</a>
  <span class="keyword">use</span> tensor.<a title="tensor.OPAdd" href="tensor.OPAdd.html">OPAdd</a>
  <span class="keyword">use</span> tensor.<a title="tensor.OPConv2d" href="tensor.OPConv2d.html">OPConv2d</a>




  <span class="keyword">type</span> <a id="farray">farray</a> = <a title="mach.c.C.ptr" href="https://www.why3.org/stdlib/mach.c.html#ptr_21">ptr</a> <a title="std.Cfloat.float" href="std.Cfloat.html#float">float</a>

  <span class="keyword">type</span> <a id="ctensor">ctensor</a> = {
    <a id="t_rank">t_rank</a> : <a title="mach.int.Int32.int32" href="https://www.why3.org/stdlib/mach.int.html#int32_283">int32</a> ;
    <a id="t_dims">t_dims</a> : <a title="libvector.CIndex.iarray" href="libvector.CIndex.html#iarray">iarray</a> ;
    <a id="t_data">t_data</a> : <a title="libtensor.CTensor.farray" href="#farray">farray</a> ;
  }

  <span class="keyword">function</span> <a id="tensor_dim">tensor_dim</a> (t : <a title="libtensor.CTensor.ctensor" href="#ctensor">ctensor</a>) : <a title="list.List.list" href="https://www.why3.org/stdlib/list.html#list_8">list</a> int = <a title="libvector.CIndex.ivector" href="libvector.CIndex.html#ivector">ivector</a> t.<a title="libtensor.CTensor.t_dims" href="#t_dims">t_dims</a> t.<a title="libtensor.CTensor.t_rank" href="#t_rank">t_rank</a>
  <span class="keyword">function</span> <a id="tensor_size">tensor_size</a> (t : <a title="libtensor.CTensor.ctensor" href="#ctensor">ctensor</a>) : int = <a title="libvector.CIndex.vdim" href="libvector.CIndex.html#vdim">vdim</a> t.<a title="libtensor.CTensor.t_dims" href="#t_dims">t_dims</a> t.<a title="libtensor.CTensor.t_rank" href="#t_rank">t_rank</a>
  <span class="keyword">predicate</span> <a id="valid_index">valid_index</a> (k : <a title="list.List.list" href="https://www.why3.org/stdlib/list.html#list_8">list</a> int) (t : <a title="libtensor.CTensor.ctensor" href="#ctensor">ctensor</a>) = <a title="tensor.Range.valid" href="tensor.Range.html#valid">valid</a> k (<a title="libtensor.CTensor.tensor_dim" href="#tensor_dim">tensor_dim</a> t)
  <span class="keyword">predicate</span> <a id="empty_tensor">empty_tensor</a> (t : <a title="libtensor.CTensor.ctensor" href="#ctensor">ctensor</a>) = t.<a title="libtensor.CTensor.t_rank" href="#t_rank">t_rank</a> = 0

  <span class="keyword">predicate</span> <a id="valid_tensor">valid_tensor</a> (t : <a title="libtensor.CTensor.ctensor" href="#ctensor">ctensor</a>) =
    <a title="libvector.CIndex.dimension" href="libvector.CIndex.html#dimension">dimension</a> t.<a title="libtensor.CTensor.t_dims" href="#t_dims">t_dims</a> t.<a title="libtensor.CTensor.t_rank" href="#t_rank">t_rank</a> /\
    <a title="std.Clib.valid_range" href="std.Clib.html#valid_range">valid_range</a> t.<a title="libtensor.CTensor.t_data" href="#t_data">t_data</a> 0 (<a title="libtensor.CTensor.tensor_size" href="#tensor_size">tensor_size</a> t) /\
    <a title="mach.c.C.writable" href="https://www.why3.org/stdlib/mach.c.html#writable_26">writable</a> t.<a title="libtensor.CTensor.t_data" href="#t_data">t_data</a>

  <span class="keyword">function</span> <a id="tensor_offset">tensor_offset</a> (k : <a title="list.List.list" href="https://www.why3.org/stdlib/list.html#list_8">list</a> int) (t : <a title="libtensor.CTensor.ctensor" href="#ctensor">ctensor</a>) : int = <a title="layout.CFlat.offset" href="layout.CFlat.html#offset">offset</a> k (<a title="libtensor.CTensor.tensor_dim" href="#tensor_dim">tensor_dim</a> t)

  <span class="keyword">function</span> <a id="tensor_value_at">tensor_value_at</a> (k : <a title="list.List.list" href="https://www.why3.org/stdlib/list.html#list_8">list</a> int) (t : <a title="libtensor.CTensor.ctensor" href="#ctensor">ctensor</a>) : real =
    <span class="keyword">if</span> <a title="libtensor.CTensor.valid_index" href="#valid_index">valid_index</a> k t <span class="keyword">then</span>
      <a title="std.Clib.value_at" href="std.Clib.html#value_at">value_at</a> t.<a title="libtensor.CTensor.t_data" href="#t_data">t_data</a> (<a title="libtensor.CTensor.tensor_offset" href="#tensor_offset">tensor_offset</a> k t)
    <span class="keyword">else</span> 0.0

  <span class="keyword">function</span> <a id="tensor_value">tensor_value</a> (t : <a title="libtensor.CTensor.ctensor" href="#ctensor">ctensor</a>) : <a title="list.List.list" href="https://www.why3.org/stdlib/list.html#list_8">list</a> int -&gt; real =
    <span class="keyword">fun</span> k -&gt; <a title="libtensor.CTensor.tensor_value_at" href="#tensor_value_at">tensor_value_at</a> k t

  <span class="keyword">function</span> <a id="tensor_valueb">tensor_valueb</a> (t : <a title="libtensor.CTensor.ctensor" href="#ctensor">ctensor</a>) : <a title="list.List.list" href="https://www.why3.org/stdlib/list.html#list_8">list</a> int -&gt; bool =
    <span class="keyword">fun</span> k -&gt; Real.(<a title="libtensor.CTensor.tensor_value_at" href="#tensor_value_at">tensor_value_at</a> k t <a title="real.Real.(>)" href="https://www.why3.org/stdlib/real.html#infix%20%3E_23">&gt;</a> 0.0)

  <span class="keyword">let</span> <span class="keyword">ghost</span> <span class="keyword">function</span> <a id="tensor">tensor</a><a href="libtensor.proof.html#CTensor.tensor" title="Valid (one goal)" class="icon valid icofont-check"></a> (t : <a title="libtensor.CTensor.ctensor" href="#ctensor">ctensor</a>) : <a title="tensor.Tensor.tensor" href="tensor.Tensor.html#tensor">tensor</a> real
    <span class="section level1"><span class="comment">{</span><span class="attribute section-toggle">proof</span><span class="comment section-text active">…</span><span class="comment">}</span><span class="section-text">
    <span class="keyword">requires</span> { <a title="libtensor.CTensor.valid_tensor" href="#valid_tensor">valid_tensor</a> t }
    <span class="keyword">ensures</span> { result.<a title="tensor.Tensor.dims" href="tensor.Tensor.html#dims">dims</a> = <a title="libtensor.CTensor.tensor_dim" href="#tensor_dim">tensor_dim</a> t }
    <span class="keyword">ensures</span> { result.<a title="tensor.Tensor.data" href="tensor.Tensor.html#data">data</a> = <a title="libtensor.CTensor.tensor_value" href="#tensor_value">tensor_value</a> t }
    <span class="keyword">ensures</span> { result.<a title="tensor.Tensor.background" href="tensor.Tensor.html#background">background</a> = 0.0 }
    <span class="comment">{</span><span class="attribute section-toggle">qed</span><span class="comment">}</span></span></span>
    = {
      <a title="tensor.Tensor.dims" href="tensor.Tensor.html#dims">dims</a> = <span class="keyword">pure</span> { <a title="libtensor.CTensor.tensor_dim" href="#tensor_dim">tensor_dim</a> t } ;
      <a title="tensor.Tensor.data" href="tensor.Tensor.html#data">data</a> = <span class="keyword">pure</span> { <a title="libtensor.CTensor.tensor_value" href="#tensor_value">tensor_value</a> t } ;
      <a title="tensor.Tensor.background" href="tensor.Tensor.html#background">background</a> = 0.0 ;
    }

  <span class="keyword">let</span> <span class="keyword">ghost</span> <span class="keyword">function</span> <a id="tensorb">tensorb</a><a href="libtensor.proof.html#CTensor.tensorb" title="Valid (one goal)" class="icon valid icofont-check"></a> (t : <a title="libtensor.CTensor.ctensor" href="#ctensor">ctensor</a>) : <a title="tensor.Tensor.tensor" href="tensor.Tensor.html#tensor">tensor</a> bool
    <span class="section level1"><span class="comment">{</span><span class="attribute section-toggle">proof</span><span class="comment section-text active">…</span><span class="comment">}</span><span class="section-text">
    <span class="keyword">requires</span> { <a title="libtensor.CTensor.valid_tensor" href="#valid_tensor">valid_tensor</a> t }
    <span class="keyword">ensures</span> { result.<a title="tensor.Tensor.dims" href="tensor.Tensor.html#dims">dims</a> = <a title="libtensor.CTensor.tensor_dim" href="#tensor_dim">tensor_dim</a> t }
    <span class="keyword">ensures</span> { result.<a title="tensor.Tensor.data" href="tensor.Tensor.html#data">data</a> = <a title="libtensor.CTensor.tensor_valueb" href="#tensor_valueb">tensor_valueb</a> t }
    <span class="keyword">ensures</span> { result.<a title="tensor.Tensor.background" href="tensor.Tensor.html#background">background</a> = <span class="keyword">false</span> }
    <span class="comment">{</span><span class="attribute section-toggle">qed</span><span class="comment">}</span></span></span>
    = {
      <a title="tensor.Tensor.dims" href="tensor.Tensor.html#dims">dims</a> = <span class="keyword">pure</span> { <a title="libtensor.CTensor.tensor_dim" href="#tensor_dim">tensor_dim</a> t } ;
      <a title="tensor.Tensor.data" href="tensor.Tensor.html#data">data</a> = <span class="keyword">pure</span> { <a title="libtensor.CTensor.tensor_valueb" href="#tensor_valueb">tensor_valueb</a> t } ;
      <a title="tensor.Tensor.background" href="tensor.Tensor.html#background">background</a> = <span class="keyword">false</span> ;
    }

  <span class="keyword">let</span> <a id="ctensor_create">ctensor_create</a><a href="libtensor.proof.html#CTensor.ctensor_create" title="Valid (one goal)" class="icon valid icofont-check"></a> (ds : <a title="libvector.CIndex.iarray" href="libvector.CIndex.html#iarray">iarray</a>) (n : <a title="mach.int.Int32.int32" href="https://www.why3.org/stdlib/mach.int.html#int32_283">int32</a>) : <a title="libtensor.CTensor.ctensor" href="#ctensor">ctensor</a> =
    <span class="section level1"><span class="comment">{</span><span class="attribute section-toggle">proof</span><span class="comment section-text active">…</span><span class="comment">}</span><span class="section-text">
    <span class="keyword">requires</span> { <a title="libvector.CIndex.dimension" href="libvector.CIndex.html#dimension">dimension</a> ds n }
    <span class="keyword">ensures</span> { <a title="libtensor.CTensor.empty_tensor" href="#empty_tensor">empty_tensor</a> result \/ <a title="libtensor.CTensor.valid_tensor" href="#valid_tensor">valid_tensor</a> result }
    <span class="keyword">ensures</span> { <a title="libtensor.CTensor.empty_tensor" href="#empty_tensor">empty_tensor</a> result \/ result.<a title="libtensor.CTensor.t_rank" href="#t_rank">t_rank</a> = n }
    <span class="keyword">ensures</span> { <a title="libtensor.CTensor.empty_tensor" href="#empty_tensor">empty_tensor</a> result \/ result.<a title="libtensor.CTensor.t_dims" href="#t_dims">t_dims</a> = ds }
    <span class="comment">{</span><span class="attribute section-toggle">qed</span><span class="comment">}</span></span></span>
    <span class="keyword">let</span> m = <a title="libvector.CIndex.cdim_size" href="libvector.CIndex.html#cdim_size">cdim_size</a> ds n <span class="keyword">in</span>
    <span class="keyword">let</span> vs = <a title="mach.c.C.malloc" href="https://www.why3.org/stdlib/mach.c.html#malloc_100">malloc</a> (<a title="std.Clib.to_uint32" href="std.Clib.html#to_uint32">to_uint32</a> m) <span class="keyword">in</span>
    {
      <a title="libtensor.CTensor.t_rank" href="#t_rank">t_rank</a> = <span class="keyword">if</span> <a title="std.Clib.is_null" href="std.Clib.html#is_null">is_null</a> vs <span class="keyword">then</span> 0 <span class="keyword">else</span> n ;
      <a title="libtensor.CTensor.t_dims" href="#t_dims">t_dims</a> = ds ;
      <a title="libtensor.CTensor.t_data" href="#t_data">t_data</a> = vs ;
    }

  <span class="keyword">let</span> <a id="ctensor_clear">ctensor_clear</a><a href="libtensor.proof.html#CTensor.ctensor_clear" title="Valid (one goal)" class="icon valid icofont-check"></a> (r : <a title="libtensor.CTensor.ctensor" href="#ctensor">ctensor</a>) =
    <span class="keyword">requires</span> { <a title="libtensor.CTensor.valid_tensor" href="#valid_tensor">valid_tensor</a> r }
    <span class="keyword">ensures</span> { <a title="libtensor.CTensor.tensor" href="#tensor">tensor</a> r = Tensor.<a title="tensor.Tensor.zero" href="tensor.Tensor.html#zero">zero</a> 0.0 (<a title="libtensor.CTensor.tensor_dim" href="#tensor_dim">tensor_dim</a> r) }
    <span class="keyword">let</span> m = <a title="libvector.CIndex.cdim_size" href="libvector.CIndex.html#cdim_size">cdim_size</a> r.<a title="libtensor.CTensor.t_dims" href="#t_dims">t_dims</a> r.<a title="libtensor.CTensor.t_rank" href="#t_rank">t_rank</a> <span class="keyword">in</span>
    <span class="keyword">for</span> i = 0 <span class="keyword">to</span> m<a title="int.Int.(-)" href="https://www.why3.org/stdlib/int.html#infix%20-_23">-</a>1 <span class="keyword">do</span>
      <span class="section level1"><span class="comment">{</span><span class="attribute section-toggle">proof</span><span class="comment section-text active">…</span><span class="comment">}</span><span class="section-text">
      <span class="keyword">invariant</span> { <span class="keyword">forall</span> k. 0 <a title="int.Int.(<=)" href="https://www.why3.org/stdlib/int.html#infix%20%3C=_25">&lt;=</a> k <a title="int.Int.(<)" href="https://www.why3.org/stdlib/int.html#infix%20%3C_21">&lt;</a> i -&gt; <a title="std.Clib.value_at" href="std.Clib.html#value_at">value_at</a> r.<a title="libtensor.CTensor.t_data" href="#t_data">t_data</a> k = 0.0 }
      <span class="comment">{</span><span class="attribute section-toggle">qed</span><span class="comment">}</span></span></span>
      r.<a title="libtensor.CTensor.t_data" href="#t_data">t_data</a>[i] &lt;- <a title="std.Cfloat.f32" href="std.Cfloat.html#f32">f32</a> 0.0
    <span class="keyword">done</span>
    <span class="section level1"><span class="comment">{</span><span class="attribute section-toggle">proof</span><span class="comment section-text active">…</span><span class="comment">}</span><span class="section-text">
    ; <span class="keyword">assert</span> { <a title="libtensor.CTensor.tensor" href="#tensor">tensor</a> r <a title="tensor.Tensor.(==)" href="tensor.Tensor.html#infix%20%3D%3D">==</a> Tensor.<a title="tensor.Tensor.zero" href="tensor.Tensor.html#zero">zero</a> 0.0 (<a title="libtensor.CTensor.tensor_dim" href="#tensor_dim">tensor_dim</a> r) }
    <span class="comment">{</span><span class="attribute section-toggle">qed</span><span class="comment">}</span></span></span>

  <span class="keyword">let</span> <a id="ctensor_reset">ctensor_reset</a><a href="libtensor.proof.html#CTensor.ctensor_reset" title="Valid (9 goals)" class="icon valid icofont-check"></a> (r : <a title="libtensor.CTensor.ctensor" href="#ctensor">ctensor</a>) (v : <a title="std.Cfloat.float" href="std.Cfloat.html#float">float</a>) =
    <span class="keyword">requires</span> { <a title="libtensor.CTensor.valid_tensor" href="#valid_tensor">valid_tensor</a> r }
    <span class="keyword">ensures</span> { <a title="libtensor.CTensor.tensor" href="#tensor">tensor</a> r = Tensor.<a title="tensor.Tensor.const" href="tensor.Tensor.html#const">const</a> (<a title="std.Cfloat.to_real" href="std.Cfloat.html#to_real">to_real</a> v) 0.0 (<a title="libtensor.CTensor.tensor_dim" href="#tensor_dim">tensor_dim</a> r) }
    <span class="keyword">let</span> m = <a title="libvector.CIndex.cdim_size" href="libvector.CIndex.html#cdim_size">cdim_size</a> r.<a title="libtensor.CTensor.t_dims" href="#t_dims">t_dims</a> r.<a title="libtensor.CTensor.t_rank" href="#t_rank">t_rank</a> <span class="keyword">in</span>
    <span class="keyword">for</span> i = 0 <span class="keyword">to</span> m<a title="int.Int.(-)" href="https://www.why3.org/stdlib/int.html#infix%20-_23">-</a>1 <span class="keyword">do</span>
      <span class="section level1"><span class="comment">{</span><span class="attribute section-toggle">proof</span><span class="comment section-text active">…</span><span class="comment">}</span><span class="section-text">
      <span class="keyword">invariant</span> { <span class="keyword">forall</span> k. 0 <a title="int.Int.(<=)" href="https://www.why3.org/stdlib/int.html#infix%20%3C=_25">&lt;=</a> k <a title="int.Int.(<)" href="https://www.why3.org/stdlib/int.html#infix%20%3C_21">&lt;</a> i -&gt; <a title="std.Clib.value_at" href="std.Clib.html#value_at">value_at</a> r.<a title="libtensor.CTensor.t_data" href="#t_data">t_data</a> k = v }
      <span class="comment">{</span><span class="attribute section-toggle">qed</span><span class="comment">}</span></span></span>
      r.<a title="libtensor.CTensor.t_data" href="#t_data">t_data</a>[i] &lt;- v
    <span class="keyword">done</span>
    <span class="section level1"><span class="comment">{</span><span class="attribute section-toggle">proof</span><span class="comment section-text active">…</span><span class="comment">}</span><span class="section-text">
    ; <span class="keyword">assert</span> { <a title="libtensor.CTensor.tensor" href="#tensor">tensor</a> r <a title="tensor.Tensor.(==)" href="tensor.Tensor.html#infix%20%3D%3D">==</a> Tensor.<a title="tensor.Tensor.const" href="tensor.Tensor.html#const">const</a> (<a title="std.Cfloat.to_real" href="std.Cfloat.html#to_real">to_real</a> v) 0.0 (<a title="libtensor.CTensor.tensor_dim" href="#tensor_dim">tensor_dim</a> r) }
    <span class="comment">{</span><span class="attribute section-toggle">qed</span><span class="comment">}</span></span></span>

  <span class="keyword">let</span> <a id="ctensor_where">ctensor_where</a><a href="libtensor.proof.html#CTensor.ctensor_where" title="Valid (12 goals)" class="icon valid icofont-check"></a> (cond a b r : <a title="libtensor.CTensor.ctensor" href="#ctensor">ctensor</a>) =
    <span class="section level1"><span class="comment">{</span><span class="attribute section-toggle">proof</span><span class="comment section-text active">…</span><span class="comment">}</span><span class="section-text">
    <span class="keyword">requires</span> { <a title="libtensor.CTensor.valid_tensor" href="#valid_tensor">valid_tensor</a> cond }
    <span class="keyword">requires</span> { <a title="libtensor.CTensor.valid_tensor" href="#valid_tensor">valid_tensor</a> a }
    <span class="keyword">requires</span> { <a title="libtensor.CTensor.valid_tensor" href="#valid_tensor">valid_tensor</a> b }
    <span class="keyword">requires</span> { <a title="libtensor.CTensor.valid_tensor" href="#valid_tensor">valid_tensor</a> r }
    <span class="keyword">requires</span> { <a title="libtensor.CTensor.tensor" href="#tensor">tensor</a> a <a title="tensor.Tensor.(~=)" href="tensor.Tensor.html#infix%20~%3D">~=</a> <a title="libtensor.CTensor.tensor" href="#tensor">tensor</a> b <a title="tensor.Tensor.(~=)" href="tensor.Tensor.html#infix%20~%3D">~=</a> <a title="libtensor.CTensor.tensor" href="#tensor">tensor</a> r }
    <span class="comment">{</span><span class="attribute section-toggle">qed</span><span class="comment">}</span></span></span>
    <span class="keyword">requires</span> { <a title="libtensor.CTensor.tensorb" href="#tensorb">tensorb</a> cond <a title="tensor.Tensor.(~)" href="tensor.Tensor.html#infix%20~">~</a> <a title="libtensor.CTensor.tensor" href="#tensor">tensor</a> a <a title="tensor.Tensor.(~)" href="tensor.Tensor.html#infix%20~">~</a> <a title="libtensor.CTensor.tensor" href="#tensor">tensor</a> b }
    <span class="keyword">ensures</span> { <a title="libtensor.CTensor.tensor" href="#tensor">tensor</a> r = <a title="tensor.OPWhere.opwhere" href="tensor.OPWhere.html#opwhere">opwhere</a> (<a title="libtensor.CTensor.tensorb" href="#tensorb">tensorb</a> cond) (<a title="libtensor.CTensor.tensor" href="#tensor">tensor</a> a) (<a title="libtensor.CTensor.tensor" href="#tensor">tensor</a> b) }
    <span class="keyword">let</span> m = <a title="libvector.CIndex.cdim_size" href="libvector.CIndex.html#cdim_size">cdim_size</a> r.<a title="libtensor.CTensor.t_dims" href="#t_dims">t_dims</a> r.<a title="libtensor.CTensor.t_rank" href="#t_rank">t_rank</a> <span class="keyword">in</span>
    <span class="keyword">for</span> i = 0 <span class="keyword">to</span> m<a title="int.Int.(-)" href="https://www.why3.org/stdlib/int.html#infix%20-_23">-</a>1 <span class="keyword">do</span>
      <span class="section level1"><span class="comment">{</span><span class="attribute section-toggle">proof</span><span class="comment section-text active">…</span><span class="comment">}</span><span class="section-text">
      <span class="keyword">invariant</span> {
        <span class="keyword">forall</span> k. 0 <a title="int.Int.(<=)" href="https://www.why3.org/stdlib/int.html#infix%20%3C=_25">&lt;=</a> k <a title="int.Int.(<)" href="https://www.why3.org/stdlib/int.html#infix%20%3C_21">&lt;</a> i -&gt;
          <a title="std.Clib.value_at" href="std.Clib.html#value_at">value_at</a> r.<a title="libtensor.CTensor.t_data" href="#t_data">t_data</a> k =
            <span class="keyword">if</span> Real.(0.0 <a title="real.Real.(<)" href="https://www.why3.org/stdlib/real.html#infix%20%3C_21">&lt;</a> <a title="std.Clib.value_at" href="std.Clib.html#value_at">value_at</a> cond.<a title="libtensor.CTensor.t_data" href="#t_data">t_data</a> k)
            <span class="keyword">then</span> a.<a title="libtensor.CTensor.t_data" href="#t_data">t_data</a>[k] <span class="keyword">else</span> b.<a title="libtensor.CTensor.t_data" href="#t_data">t_data</a>[k]
      }
      <span class="comment">{</span><span class="attribute section-toggle">qed</span><span class="comment">}</span></span></span>
      r.<a title="libtensor.CTensor.t_data" href="#t_data">t_data</a>[i] &lt;-
        <span class="keyword">if</span> (<a title="std.Cfloat.f32" href="std.Cfloat.html#f32">f32</a> 0.0) <a title="std.Cfloat.(.<)" href="std.Cfloat.html#infix%20.%3C">.&lt;</a> cond.<a title="libtensor.CTensor.t_data" href="#t_data">t_data</a>[i] <span class="keyword">then</span> a.<a title="libtensor.CTensor.t_data" href="#t_data">t_data</a>[i] <span class="keyword">else</span> b.<a title="libtensor.CTensor.t_data" href="#t_data">t_data</a>[i]
    <span class="keyword">done</span>
    <span class="section level1"><span class="comment">{</span><span class="attribute section-toggle">proof</span><span class="comment section-text active">…</span><span class="comment">}</span><span class="section-text">
    ; <span class="keyword">assert</span> { <a title="libtensor.CTensor.tensor" href="#tensor">tensor</a> r <a title="tensor.Tensor.(==)" href="tensor.Tensor.html#infix%20%3D%3D">==</a> <a title="tensor.OPWhere.opwhere" href="tensor.OPWhere.html#opwhere">opwhere</a> (<a title="libtensor.CTensor.tensorb" href="#tensorb">tensorb</a> cond) (<a title="libtensor.CTensor.tensor" href="#tensor">tensor</a> a) (<a title="libtensor.CTensor.tensor" href="#tensor">tensor</a> b) }
    <span class="comment">{</span><span class="attribute section-toggle">qed</span><span class="comment">}</span></span></span>

<span class="keyword">let</span> <a id="ctensor_add">ctensor_add</a><a href="libtensor.proof.html#CTensor.ctensor_add" title="Valid (one goal)" class="icon valid icofont-check"></a> (a b r : <a title="libtensor.CTensor.ctensor" href="#ctensor">ctensor</a>) =
    <span class="keyword">requires</span> { <a title="libtensor.CTensor.valid_tensor" href="#valid_tensor">valid_tensor</a> a }
    <span class="keyword">requires</span> { <a title="libtensor.CTensor.valid_tensor" href="#valid_tensor">valid_tensor</a> b }
    <span class="keyword">requires</span> { <a title="libtensor.CTensor.valid_tensor" href="#valid_tensor">valid_tensor</a> r }
    <span class="keyword">requires</span> { <a title="libtensor.CTensor.tensor" href="#tensor">tensor</a> a <a title="tensor.Tensor.(~=)" href="tensor.Tensor.html#infix%20~%3D">~=</a> <a title="libtensor.CTensor.tensor" href="#tensor">tensor</a> b <a title="tensor.Tensor.(~=)" href="tensor.Tensor.html#infix%20~%3D">~=</a> <a title="libtensor.CTensor.tensor" href="#tensor">tensor</a> r }
    <span class="keyword">ensures</span> { <a title="libtensor.CTensor.tensor" href="#tensor">tensor</a> r = <a title="tensor.OPAdd.opadd" href="tensor.OPAdd.html#opadd">opadd</a> (<a title="libtensor.CTensor.tensor" href="#tensor">tensor</a> a) (<a title="libtensor.CTensor.tensor" href="#tensor">tensor</a> b) }
    <span class="keyword">let</span> m = <a title="libvector.CIndex.cdim_size" href="libvector.CIndex.html#cdim_size">cdim_size</a> r.<a title="libtensor.CTensor.t_dims" href="#t_dims">t_dims</a> r.<a title="libtensor.CTensor.t_rank" href="#t_rank">t_rank</a> <span class="keyword">in</span>
    <span class="keyword">for</span> i = 0 <span class="keyword">to</span> m<a title="int.Int.(-)" href="https://www.why3.org/stdlib/int.html#infix%20-_23">-</a>1 <span class="keyword">do</span>
      <span class="keyword">invariant</span> { <span class="keyword">forall</span> k.
        0 <a title="int.Int.(<=)" href="https://www.why3.org/stdlib/int.html#infix%20%3C=_25">&lt;=</a> k <a title="int.Int.(<)" href="https://www.why3.org/stdlib/int.html#infix%20%3C_21">&lt;</a> i -&gt;
          <a title="std.Clib.value_at" href="std.Clib.html#value_at">value_at</a> r.<a title="libtensor.CTensor.t_data" href="#t_data">t_data</a> k =
            <a title="std.Clib.value_at" href="std.Clib.html#value_at">value_at</a> a.<a title="libtensor.CTensor.t_data" href="#t_data">t_data</a> k <a title="std.Cfloat.(.+)" href="std.Cfloat.html#infix%20.%2B">.+</a> <a title="std.Clib.value_at" href="std.Clib.html#value_at">value_at</a> b.<a title="libtensor.CTensor.t_data" href="#t_data">t_data</a> k
      }
      r.<a title="libtensor.CTensor.t_data" href="#t_data">t_data</a>[i] &lt;- a.<a title="libtensor.CTensor.t_data" href="#t_data">t_data</a>[i] <a title="std.Cfloat.(.+)" href="std.Cfloat.html#infix%20.%2B">.+</a> b.<a title="libtensor.CTensor.t_data" href="#t_data">t_data</a>[i]
    <span class="keyword">done</span>
    ;
    <span class="keyword">assert</span> { <a title="libtensor.CTensor.tensor" href="#tensor">tensor</a> r <a title="tensor.Tensor.(==)" href="tensor.Tensor.html#infix%20%3D%3D">==</a> <a title="tensor.OPAdd.opadd" href="tensor.OPAdd.html#opadd">opadd</a> (<a title="libtensor.CTensor.tensor" href="#tensor">tensor</a> a) (<a title="libtensor.CTensor.tensor" href="#tensor">tensor</a> b) }

<span class="comment">(* ===== SECTION 1: Function Definition and Pre/Postconditions ===== *)</span>

 <span class="comment">(* Goal: Implements the imperative 2D convolution operation (Conv2D) by iterating over all output pixels,
     * calculating the weighted sum, and storing the result in the &#39;output&#39; tensor.
     * Inputs:
     * x, w, b: ctensor - Input, Kernel (weights), and Bias tensors.
     * pad_top...str_w: int32 - Convolution attributes (Padding, Dilation, Stride).
     * output: ctensor - The tensor where the result will be stored (modified in-place).
     * Outputs: unit (returns nothing, modifies &#39;output&#39; in-place). *)</span>
<span class="keyword">let</span> <a id="ctensor_conv2d">ctensor_conv2d</a><a href="libtensor.proof.html#CTensor.ctensor_conv2d" title="Partial proof (201/247 goals)" class="icon warning icofont-error"></a> (x : <a title="libtensor.CTensor.ctensor" href="#ctensor">ctensor</a>) (w : <a title="libtensor.CTensor.ctensor" href="#ctensor">ctensor</a>) (b : <a title="libtensor.CTensor.ctensor" href="#ctensor">ctensor</a>) 
                   (pad_top pad_bottom pad_left pad_right : <a title="mach.int.Int32.int32" href="https://www.why3.org/stdlib/mach.int.html#int32_283">int32</a>)
                   (dil_h dil_w : <a title="mach.int.Int32.int32" href="https://www.why3.org/stdlib/mach.int.html#int32_283">int32</a>) (str_h str_w : <a title="mach.int.Int32.int32" href="https://www.why3.org/stdlib/mach.int.html#int32_283">int32</a>)
                   (output : <a title="libtensor.CTensor.ctensor" href="#ctensor">ctensor</a>): unit  =
    <span class="keyword">requires</span> { <a title="libtensor.CTensor.valid_tensor" href="#valid_tensor">valid_tensor</a> x }
    <span class="keyword">requires</span> { <a title="libtensor.CTensor.valid_tensor" href="#valid_tensor">valid_tensor</a> w }
    <span class="keyword">requires</span> { <a title="libtensor.CTensor.valid_tensor" href="#valid_tensor">valid_tensor</a> b }
    <span class="keyword">requires</span> { <a title="libtensor.CTensor.valid_tensor" href="#valid_tensor">valid_tensor</a> output }
    <span class="keyword">requires</span> { x.<a title="libtensor.CTensor.t_rank" href="#t_rank">t_rank</a> = 4 }  <span class="comment">(* Input tensor [N, C, H, W] *)</span>
    <span class="keyword">requires</span> { w.<a title="libtensor.CTensor.t_rank" href="#t_rank">t_rank</a> = 4 }  <span class="comment">(* Kernel tensor [M, C, kH, kW] *)</span>
    <span class="keyword">requires</span> { b.<a title="libtensor.CTensor.t_rank" href="#t_rank">t_rank</a> = 1 }  <span class="comment">(* Bias tensor [M] *)</span>
    <span class="keyword">requires</span> { output.<a title="libtensor.CTensor.t_rank" href="#t_rank">t_rank</a> = 4 }  <span class="comment">(* Output tensor [N, M, oH, oW] *)</span>


    <span class="comment">(* Attribute constraints: Stride and Dilation must be positive, Padding must be non-negative. *)</span>
    <span class="keyword">requires</span> { str_h <a title="int.Int.(>)" href="https://www.why3.org/stdlib/int.html#infix%20%3E_24">&gt;</a> 0 /\ str_w <a title="int.Int.(>)" href="https://www.why3.org/stdlib/int.html#infix%20%3E_24">&gt;</a> 0 }
    <span class="keyword">requires</span> { dil_h <a title="int.Int.(>)" href="https://www.why3.org/stdlib/int.html#infix%20%3E_24">&gt;</a> 0 /\ dil_w <a title="int.Int.(>)" href="https://www.why3.org/stdlib/int.html#infix%20%3E_24">&gt;</a> 0 }
    <span class="keyword">requires</span> { pad_top <a title="int.Int.(>=)" href="https://www.why3.org/stdlib/int.html#infix%20%3E=_26">&gt;=</a> 0 /\ pad_bottom <a title="int.Int.(>=)" href="https://www.why3.org/stdlib/int.html#infix%20%3E=_26">&gt;=</a> 0 /\ pad_left <a title="int.Int.(>=)" href="https://www.why3.org/stdlib/int.html#infix%20%3E=_26">&gt;=</a> 0 /\ pad_right <a title="int.Int.(>=)" href="https://www.why3.org/stdlib/int.html#infix%20%3E=_26">&gt;=</a> 0 }
    <span class="comment">(* Postcondition: The concrete tensor &#39;output&#39; must be equal to the ghost specification of Conv2D. *)</span>
    <span class="keyword">ensures</span> { <a title="libtensor.CTensor.tensor" href="#tensor">tensor</a> output = OPConv2d.<a title="tensor.OPConv2d.opconv2d" href="tensor.OPConv2d.html#opconv2d">opconv2d</a> (<a title="libtensor.CTensor.tensor" href="#tensor">tensor</a> x) (<a title="libtensor.CTensor.tensor" href="#tensor">tensor</a> w) (<a title="libtensor.CTensor.tensor" href="#tensor">tensor</a> b) 
                                                (Int32.<a title="mach.int.Int32.to_int" href="https://www.why3.org/stdlib/mach.int.html#to_int_289">to_int</a> pad_top) (Int32.<a title="mach.int.Int32.to_int" href="https://www.why3.org/stdlib/mach.int.html#to_int_289">to_int</a> pad_bottom) 
                                                (Int32.<a title="mach.int.Int32.to_int" href="https://www.why3.org/stdlib/mach.int.html#to_int_289">to_int</a> pad_left) (Int32.<a title="mach.int.Int32.to_int" href="https://www.why3.org/stdlib/mach.int.html#to_int_289">to_int</a> pad_right)
                                                (Int32.<a title="mach.int.Int32.to_int" href="https://www.why3.org/stdlib/mach.int.html#to_int_289">to_int</a> dil_h) (Int32.<a title="mach.int.Int32.to_int" href="https://www.why3.org/stdlib/mach.int.html#to_int_289">to_int</a> dil_w) 
                                                (Int32.<a title="mach.int.Int32.to_int" href="https://www.why3.org/stdlib/mach.int.html#to_int_289">to_int</a> str_h) (Int32.<a title="mach.int.Int32.to_int" href="https://www.why3.org/stdlib/mach.int.html#to_int_289">to_int</a> str_w) }


    <span class="comment">(* ===== SECTION 2: Dimension Extraction and Variable Initialization ===== *)</span>

    <span class="comment">(* Extraction des dimensions de chaque tenseur pour les limites des boucles *)</span>
    <span class="keyword">let</span> n_batches = x.<a title="libtensor.CTensor.t_dims" href="#t_dims">t_dims</a>[0] <span class="keyword">in</span> <span class="comment">(* Batch size (N) *)</span>
    <span class="keyword">let</span> c_in = x.<a title="libtensor.CTensor.t_dims" href="#t_dims">t_dims</a>[1] <span class="keyword">in</span> <span class="comment">(* Input Channels (C_in) *)</span>
    <span class="keyword">let</span> h_in = x.<a title="libtensor.CTensor.t_dims" href="#t_dims">t_dims</a>[2] <span class="keyword">in</span> <span class="comment">(* Input Height (H_in) *)</span>
    <span class="keyword">let</span> w_in = x.<a title="libtensor.CTensor.t_dims" href="#t_dims">t_dims</a>[3] <span class="keyword">in</span> <span class="comment">(* Input Width (W_in) *)</span>
    <span class="keyword">let</span> m_out = w.<a title="libtensor.CTensor.t_dims" href="#t_dims">t_dims</a>[0] <span class="keyword">in</span> <span class="comment">(* Output Channels / Kernel count (M) *)</span>
    <span class="keyword">let</span> kh = w.<a title="libtensor.CTensor.t_dims" href="#t_dims">t_dims</a>[2] <span class="keyword">in</span> <span class="comment">(* Kernel Height (kH) *)</span>
    <span class="keyword">let</span> kw = w.<a title="libtensor.CTensor.t_dims" href="#t_dims">t_dims</a>[3] <span class="keyword">in</span> <span class="comment">(* Kernel Width (kW) *)</span>

    <span class="keyword">let</span> h_out = output.<a title="libtensor.CTensor.t_dims" href="#t_dims">t_dims</a>[2] <span class="keyword">in</span> <span class="comment">(* Output Height (oH) *)</span>
    <span class="keyword">let</span> w_out = output.<a title="libtensor.CTensor.t_dims" href="#t_dims">t_dims</a>[3] <span class="keyword">in</span> <span class="comment">(* Output Width (oW) *)</span>


    <span class="comment">(* Conversion des paramètres de convolution en variables locales (int32 -&gt; int32) *)</span>
    <span class="keyword">let</span> pad_top_i = pad_top <span class="keyword">in</span>
    <span class="keyword">let</span> pad_left_i =  pad_left <span class="keyword">in</span>
    <span class="keyword">let</span> dil_h_i =  dil_h <span class="keyword">in</span>
    <span class="keyword">let</span> dil_w_i =  dil_w <span class="keyword">in</span>
    <span class="keyword">let</span> str_h_i =  str_h <span class="keyword">in</span>
    <span class="keyword">let</span> str_w_i =  str_w <span class="keyword">in</span>


    <span class="comment">(* Allocation de tableaux temporaires pour stocker les coordonnées 4D (X, W, Output) ou 1D (B)
     * Ces tableaux sont utilisés par la fonction &#39;coffset&#39; pour calculer l&#39;indice 1D dans t_data. *)</span>
    <span class="keyword">let</span> x_coords = <a title="std.Clib.malloc_int32" href="std.Clib.html#malloc_int32">malloc_int32</a> (<a title="std.Clib.to_uint32" href="std.Clib.html#to_uint32">to_uint32</a> 4) <span class="keyword">in</span>
    <span class="keyword">let</span> w_coords = <a title="std.Clib.malloc_int32" href="std.Clib.html#malloc_int32">malloc_int32</a> (<a title="std.Clib.to_uint32" href="std.Clib.html#to_uint32">to_uint32</a> 4) <span class="keyword">in</span>   
    <span class="keyword">let</span> b_coords = <a title="std.Clib.malloc_int32" href="std.Clib.html#malloc_int32">malloc_int32</a> (<a title="std.Clib.to_uint32" href="std.Clib.html#to_uint32">to_uint32</a> 1) <span class="keyword">in</span>
    <span class="keyword">let</span> output_coords = <a title="std.Clib.malloc_int32" href="std.Clib.html#malloc_int32">malloc_int32</a> (<a title="std.Clib.to_uint32" href="std.Clib.html#to_uint32">to_uint32</a> 4) <span class="keyword">in</span>

    <span class="keyword">if</span> <a title="mach.c.C.is_not_null" href="https://www.why3.org/stdlib/mach.c.html#is_not_null_40">is_not_null</a> x_coords &amp;&amp; <a title="mach.c.C.is_not_null" href="https://www.why3.org/stdlib/mach.c.html#is_not_null_40">is_not_null</a> w_coords &amp;&amp; <a title="mach.c.C.is_not_null" href="https://www.why3.org/stdlib/mach.c.html#is_not_null_40">is_not_null</a> b_coords &amp;&amp; <a title="mach.c.C.is_not_null" href="https://www.why3.org/stdlib/mach.c.html#is_not_null_40">is_not_null</a> output_coords <span class="keyword">then</span> <span class="keyword">begin</span>
        <span class="comment">(* Boucles imbriquées pour calculer la convolution *)</span>
        <span class="comment">(* ===== SECTION 3: Core Iteration Loops (Output Tensor) ===== *)</span>
        <span class="keyword">for</span> n = 0 <span class="keyword">to</span> n_batches <a title="int.Int.(-)" href="https://www.why3.org/stdlib/int.html#infix%20-_23">-</a> 1 <span class="keyword">do</span> <span class="comment">(* Loop over Batch dimension (N) *)</span>
            <span class="keyword">invariant</span> { <span class="keyword">true</span> }
            <span class="keyword">for</span> m = 0 <span class="keyword">to</span> m_out <a title="int.Int.(-)" href="https://www.why3.org/stdlib/int.html#infix%20-_23">-</a> 1 <span class="keyword">do</span> <span class="comment">(* Loop over Output Channels (M) *)</span>
                <span class="keyword">invariant</span> { <span class="keyword">true</span> }
                <span class="keyword">for</span> oh = 0 <span class="keyword">to</span> h_out <a title="int.Int.(-)" href="https://www.why3.org/stdlib/int.html#infix%20-_23">-</a> 1 <span class="keyword">do</span> <span class="comment">(* Loop over Output Height (oH) *)</span>
                    <span class="keyword">invariant</span> { <span class="keyword">true</span> }
                    <span class="keyword">for</span> ow = 0 <span class="keyword">to</span> w_out <a title="int.Int.(-)" href="https://www.why3.org/stdlib/int.html#infix%20-_23">-</a> 1 <span class="keyword">do</span> <span class="comment">(* Loop over Output Width (oW) *)</span>
                        <span class="keyword">invariant</span> { <span class="keyword">true</span> }

                        <span class="comment">(* Initialisation de l&#39;accumulateur pour le produit scalaire (dot product) *)</span>
                        <span class="keyword">let</span> conv_sum = ref (<a title="std.Cfloat.f64" href="std.Cfloat.html#f64">f64</a> 0.0) <span class="keyword">in</span>

                        <span class="comment">(* ===== SECTION 4: Convolution and Summation Loops (Kernel) ===== *)</span>

                        <span class="keyword">for</span> c = 0 <span class="keyword">to</span> c_in <a title="int.Int.(-)" href="https://www.why3.org/stdlib/int.html#infix%20-_23">-</a> 1 <span class="keyword">do</span> <span class="comment">(* Loop over Input Channels (C) *)</span>
                            <span class="keyword">invariant</span> { <span class="keyword">true</span> }
                            <span class="keyword">for</span> k_h = 0 <span class="keyword">to</span> kh <a title="int.Int.(-)" href="https://www.why3.org/stdlib/int.html#infix%20-_23">-</a> 1 <span class="keyword">do</span> <span class="comment">(* Loop over Kernel Height (kH) *)</span>
                                <span class="keyword">invariant</span> { <span class="keyword">true</span> }
                                <span class="keyword">for</span> k_w = 0 <span class="keyword">to</span> kw <a title="int.Int.(-)" href="https://www.why3.org/stdlib/int.html#infix%20-_23">-</a> 1 <span class="keyword">do</span> <span class="comment">(* Loop over Kernel Width (kW) *)</span>
                                    <span class="keyword">invariant</span> { <span class="keyword">true</span> }

                                    <span class="comment">(* 1. Calculate the indices in the input space *with padding* (ih, iw) *)</span>
                                    <span class="keyword">let</span> ih = oh <a title="int.Int.(*)" href="https://www.why3.org/stdlib/int.html#infix%20*_20">*</a> str_h_i <a title="int.Int.(+)" href="https://www.why3.org/stdlib/int.html#infix%20+_19">+</a> k_h <a title="int.Int.(*)" href="https://www.why3.org/stdlib/int.html#infix%20*_20">*</a> dil_h_i <span class="keyword">in</span>
                                    <span class="keyword">let</span> iw = ow <a title="int.Int.(*)" href="https://www.why3.org/stdlib/int.html#infix%20*_20">*</a> str_w_i <a title="int.Int.(+)" href="https://www.why3.org/stdlib/int.html#infix%20+_19">+</a> k_w <a title="int.Int.(*)" href="https://www.why3.org/stdlib/int.html#infix%20*_20">*</a> dil_w_i <span class="keyword">in</span>

                                    <span class="comment">(* 2. Convert to *original* input indices (after subtracting padding) *)</span>
                                    <span class="keyword">let</span> padded_ih = ih <a title="int.Int.(-)" href="https://www.why3.org/stdlib/int.html#infix%20-_23">-</a> pad_top_i <span class="keyword">in</span>
                                    <span class="keyword">let</span> padded_iw = iw <a title="int.Int.(-)" href="https://www.why3.org/stdlib/int.html#infix%20-_23">-</a> pad_left_i <span class="keyword">in</span>
                                    <span class="comment">(* 3. Retrieve the input value (X) with zero-padding handling *)</span>
                                    <span class="keyword">let</span> x_val = 
                                        <span class="keyword">if</span> 0 <a title="int.Int.(<=)" href="https://www.why3.org/stdlib/int.html#infix%20%3C=_25">&lt;=</a> padded_ih &amp;&amp; padded_ih <a title="int.Int.(<)" href="https://www.why3.org/stdlib/int.html#infix%20%3C_21">&lt;</a> h_in &amp;&amp; 0 <a title="int.Int.(<=)" href="https://www.why3.org/stdlib/int.html#infix%20%3C=_25">&lt;=</a> padded_iw &amp;&amp; padded_iw <a title="int.Int.(<)" href="https://www.why3.org/stdlib/int.html#infix%20%3C_21">&lt;</a> w_in <span class="keyword">then</span> <span class="keyword">begin</span>
                                            <span class="comment">(* Calculate the X offset if the index is within the original bounds *)</span>
                                            <a title="mach.c.C.set_ofs" href="https://www.why3.org/stdlib/mach.c.html#set_ofs_75">set_ofs</a> x_coords 0 n;
                                            <a title="mach.c.C.set_ofs" href="https://www.why3.org/stdlib/mach.c.html#set_ofs_75">set_ofs</a> x_coords 1 c; 
                                            <a title="mach.c.C.set_ofs" href="https://www.why3.org/stdlib/mach.c.html#set_ofs_75">set_ofs</a> x_coords 2 padded_ih;
                                            <a title="mach.c.C.set_ofs" href="https://www.why3.org/stdlib/mach.c.html#set_ofs_75">set_ofs</a> x_coords 3 padded_iw;
                                            <span class="keyword">let</span> x_offset = <a title="libvector.CIndex.coffset" href="libvector.CIndex.html#coffset">coffset</a> x_coords x.<a title="libtensor.CTensor.t_dims" href="#t_dims">t_dims</a> 4 <span class="keyword">in</span>
                                            <span class="keyword">if</span> x_offset <a title="int.Int.(>=)" href="https://www.why3.org/stdlib/int.html#infix%20%3E=_26">&gt;=</a> 0 <span class="keyword">then</span> x.<a title="libtensor.CTensor.t_data" href="#t_data">t_data</a>[x_offset] <span class="keyword">else</span> <a title="std.Cfloat.f64" href="std.Cfloat.html#f64">f64</a> 0.0 <span class="comment">(* Value of X *)</span>
                                        <span class="keyword">end</span> <span class="keyword">else</span> <a title="std.Cfloat.f64" href="std.Cfloat.html#f64">f64</a> 0.0 <span class="comment">(* Value 0.0 for padding *)</span>
                                    <span class="keyword">in</span>

                                    <span class="comment">(* 4. Retrieve the kernel value (W) and calculate its offset *)</span>
                                    <a title="mach.c.C.set_ofs" href="https://www.why3.org/stdlib/mach.c.html#set_ofs_75">set_ofs</a> w_coords 0 m;
                                    <a title="mach.c.C.set_ofs" href="https://www.why3.org/stdlib/mach.c.html#set_ofs_75">set_ofs</a> w_coords 1 c;
                                    <a title="mach.c.C.set_ofs" href="https://www.why3.org/stdlib/mach.c.html#set_ofs_75">set_ofs</a> w_coords 2 k_h;
                                    <a title="mach.c.C.set_ofs" href="https://www.why3.org/stdlib/mach.c.html#set_ofs_75">set_ofs</a> w_coords 3 k_w;
                                    <span class="keyword">let</span> w_offset = <a title="libvector.CIndex.coffset" href="libvector.CIndex.html#coffset">coffset</a> w_coords w.<a title="libtensor.CTensor.t_dims" href="#t_dims">t_dims</a> 4 <span class="keyword">in</span>
                                    <span class="keyword">let</span> w_val = <span class="keyword">if</span> w_offset <a title="int.Int.(>=)" href="https://www.why3.org/stdlib/int.html#infix%20%3E=_26">&gt;=</a> 0 <span class="keyword">then</span> w.<a title="libtensor.CTensor.t_data" href="#t_data">t_data</a>[w_offset] <span class="keyword">else</span> <a title="std.Cfloat.f64" href="std.Cfloat.html#f64">f64</a> 0.0 <span class="keyword">in</span>

                                    <span class="comment">(* 5. Accumulate the product X_val * W_val into the convolution sum *)</span>
                                    conv_sum <a title="ref.Ref.(:=)" href="https://www.why3.org/stdlib/ref.html#infix%20:=_20">:=</a> <a title="ref.Ref.(!)" href="https://www.why3.org/stdlib/ref.html#prefix%20!_18">!</a>conv_sum <a title="std.Cfloat.(.+)" href="std.Cfloat.html#infix%20.%2B">.+</a> (x_val <a title="std.Cfloat.(.*)" href="std.Cfloat.html#infix%20.%2A">.*</a> w_val)
                                <span class="keyword">done</span>
                            <span class="keyword">done</span>
                        <span class="keyword">done</span>;

                       <span class="comment">(* ===== SECTION 5: Final Result Calculation and Assignment ===== *)</span>

                       <span class="comment">(* 6. Add the bias (B) (corresponding to the output channel m) *)</span>
                        <a title="mach.c.C.set_ofs" href="https://www.why3.org/stdlib/mach.c.html#set_ofs_75">set_ofs</a> b_coords 0 m;
                        <span class="keyword">let</span> b_offset = <a title="libvector.CIndex.coffset" href="libvector.CIndex.html#coffset">coffset</a> b_coords b.<a title="libtensor.CTensor.t_dims" href="#t_dims">t_dims</a> 1 <span class="keyword">in</span>
                        <span class="keyword">let</span> bias_val = <span class="keyword">if</span> b_offset <a title="int.Int.(>=)" href="https://www.why3.org/stdlib/int.html#infix%20%3E=_26">&gt;=</a> 0 <span class="keyword">then</span> b.<a title="libtensor.CTensor.t_data" href="#t_data">t_data</a>[b_offset] <span class="keyword">else</span> <a title="std.Cfloat.f64" href="std.Cfloat.html#f64">f64</a> 0.0 <span class="keyword">in</span>
                        <span class="keyword">let</span> final_val = <a title="ref.Ref.(!)" href="https://www.why3.org/stdlib/ref.html#prefix%20!_18">!</a>conv_sum <a title="std.Cfloat.(.+)" href="std.Cfloat.html#infix%20.%2B">.+</a> bias_val <span class="keyword">in</span>

                      <span class="comment">(* 7. Calculate the final offset and store the result in the &#39;output&#39; data array *)</span>
                        <a title="mach.c.C.set_ofs" href="https://www.why3.org/stdlib/mach.c.html#set_ofs_75">set_ofs</a> output_coords 0 n;
                        <a title="mach.c.C.set_ofs" href="https://www.why3.org/stdlib/mach.c.html#set_ofs_75">set_ofs</a> output_coords 1 m;
                        <a title="mach.c.C.set_ofs" href="https://www.why3.org/stdlib/mach.c.html#set_ofs_75">set_ofs</a> output_coords 2 oh;
                        <a title="mach.c.C.set_ofs" href="https://www.why3.org/stdlib/mach.c.html#set_ofs_75">set_ofs</a> output_coords 3 ow;
                        <span class="keyword">let</span> output_offset = <a title="libvector.CIndex.coffset" href="libvector.CIndex.html#coffset">coffset</a> output_coords output.<a title="libtensor.CTensor.t_dims" href="#t_dims">t_dims</a> 4 <span class="keyword">in</span>
                        <span class="keyword">if</span> output_offset <a title="int.Int.(>=)" href="https://www.why3.org/stdlib/int.html#infix%20%3E=_26">&gt;=</a> 0 <span class="keyword">then</span> output.<a title="libtensor.CTensor.t_data" href="#t_data">t_data</a>[output_offset] &lt;- final_val
                    <span class="keyword">done</span>
                <span class="keyword">done</span>
            <span class="keyword">done</span>
        <span class="keyword">done</span>
    <span class="keyword">end</span>




<span class="keyword">end</span>
</pre>
<script type="text/javascript" src="script.js"></script>
</body>
</html>
